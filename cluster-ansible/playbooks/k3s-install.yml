---
- name: Deploy K3s Cluster
  hosts: k3s_cluster
  gather_facts: true
  become: true

  pre_tasks:
    - name: Load default group vars
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../group_vars/k3s_cluster.yml"
      failed_when: false
      changed_when: false

    - name: Load cluster-specific group vars override
      # This file only overrides keys that are defined in cluster_{{ cluster_name }}.yml
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../group_vars/cluster_{{ cluster_name }}.yml"
      failed_when: false
      changed_when: false

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - curl
          - apt-transport-https
          - ca-certificates
          - software-properties-common
        state: present

    - name: Create K3s config directory
      ansible.builtin.file:
        path: "{{ k3s_config_dir }}"
        state: directory
        mode: '0755'

    - name: Create registries directory
      ansible.builtin.file:
        path: "{{ k3s_config_dir }}/registries.d"
        state: directory
        mode: '0755'

- name: Setup K3s Master Node
  hosts: k3s_master
  gather_facts: true
  become: true

  tasks:
    - name: Deploy K3s server config.yaml
      ansible.builtin.template:
        src: templates/k3s-server-config.yaml.j2
        dest: "{{ k3s_config_dir }}/config.yaml"
        mode: '0644'

    - name: Deploy registries.yaml for server
      ansible.builtin.template:
        src: templates/registries.yaml.j2
        dest: "{{ k3s_config_dir }}/registries.yaml"
        mode: '0644'

    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install K3s server
      ansible.builtin.shell: |
        set -o pipefail
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - server
      args:
        executable: /bin/bash
      when: not k3s_binary.stat.exists
      changed_when: true
      environment:
        INSTALL_K3S_SKIP_START: "false"

    - name: Wait for K3s to be ready
      ansible.builtin.wait_for:
        port: 6443
        delay: 5
        timeout: 300

    - name: Wait for node to be ready
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get nodes | grep -w "Ready"
      args:
        executable: /bin/bash
      register: node_ready
      until: node_ready.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Validate kubeconfig_file is provided
      ansible.builtin.assert:
        that:
          - kubeconfig_file is defined
          - kubeconfig_file | length > 0
        fail_msg: "kubeconfig_file variable is required but was not provided"
        quiet: false

    - name: Fetch kubeconfig to local machine
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ kubeconfig_file }}"
        flat: true

    - name: Replace localhost with master IP in kubeconfig
      ansible.builtin.replace:
        path: "{{ kubeconfig_file }}"
        regexp: 'server: https://(127\.0\.0\.1|localhost):6443'
        replace: 'server: https://{{ hostvars[groups["k3s_master"][0]]["ansible_host"] }}:6443'
      delegate_to: localhost

    - name: Display cluster info
      ansible.builtin.command:
        cmd: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: cluster_info
      changed_when: false

    - name: Show cluster nodes
      ansible.builtin.debug:
        msg: "{{ cluster_info.stdout_lines }}"

- name: Setup K3s Agent Nodes
  hosts: k3s_agents
  gather_facts: true
  become: true

  tasks:
    - name: Deploy K3s agent config.yaml
      ansible.builtin.template:
        src: templates/k3s-agent-config.yaml.j2
        dest: "{{ k3s_config_dir }}/config.yaml"
        mode: '0644'

    - name: Deploy registries.yaml for agent
      ansible.builtin.template:
        src: templates/registries.yaml.j2
        dest: "{{ k3s_config_dir }}/registries.yaml"
        mode: '0644'

    - name: Check if K3s agent is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_agent_binary

    - name: Install K3s agent
      ansible.builtin.shell: |
        set -o pipefail
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - agent
      args:
        executable: /bin/bash
      when: not k3s_agent_binary.stat.exists
      changed_when: true
      environment:
        INSTALL_K3S_SKIP_START: "false"

    - name: Wait for agent to join cluster
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get nodes --no-headers | grep -w "{{ inventory_hostname }}" | grep -w "Ready"
      args:
        executable: /bin/bash
      delegate_to: "{{ groups['k3s_master'][0] }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: agent_joined
      until: agent_joined.rc == 0
      retries: 30
      delay: 10
      changed_when: false

- name: Post-Installation Verification
  hosts: k3s_master
  gather_facts: false
  become: true

  tasks:
    - name: Wait for all nodes to be ready
      ansible.builtin.shell: |
        set -o pipefail
        count=$(kubectl get nodes --no-headers | awk '{print $2}' | (grep -v "Ready" || true) | wc -l | tr -d '\n')
        echo -n "${count:-0}"
      args:
        executable: /bin/bash
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: not_ready_nodes
      until: not_ready_nodes.stdout == "0"
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false

    - name: Display all nodes
      ansible.builtin.command:
        cmd: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: all_nodes
      changed_when: false

    - name: Show all nodes
      ansible.builtin.debug:
        msg: "{{ all_nodes.stdout_lines }}"

    - name: Check registry configuration
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get svc -A | grep registry || echo "No registry service found yet"
      args:
        executable: /bin/bash
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: registry_status
      changed_when: false

    - name: Show registry status
      ansible.builtin.debug:
        msg: "{{ registry_status.stdout_lines }}"
